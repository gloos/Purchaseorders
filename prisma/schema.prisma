// Prisma schema for PO Tool
// This defines the database models and relationships

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - represents authenticated users
// Note: Supabase handles auth in its own schema, this is for app-specific user data
model User {
  id             String        @id @default(uuid()) // Matches Supabase auth.users.id
  email          String        @unique
  name           String?
  avatarUrl      String?
  role           UserRole      @default(VIEWER) // User's role within their organization
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdPurchaseOrders PurchaseOrder[] @relation("CreatedPOs")

  @@map("users")
}

// Organization model - represents companies/organizations using the tool
model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // FreeAgent OAuth tokens
  freeAgentAccessToken  String?
  freeAgentRefreshToken String?
  freeAgentTokenExpiry  DateTime?

  // Company Profile Information
  companyRegistrationNumber String?
  vatNumber                 String?
  addressLine1              String?
  addressLine2              String?
  city                      String?
  region                    String?
  postcode                  String?
  country                   String?
  phone                     String?
  email                     String?
  website                   String?
  logoUrl                   String?

  // FreeAgent company sync
  freeAgentCompanyUrl       String?
  companySyncedAt           DateTime?

  // Relations
  users          User[]
  purchaseOrders PurchaseOrder[]
  contacts       Contact[]
  counters       Counter[]
  taxRates       TaxRate[]

  @@map("organizations")
}

// Contact/Supplier model - synced from FreeAgent
model Contact {
  id                String    @id @default(uuid())
  freeAgentId       String    @unique
  name              String
  email             String?
  phone             String?
  address           String?
  isActive          Boolean   @default(true)
  syncedAt          DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("contacts")
  @@index([organizationId])
  @@index([freeAgentId])
}

// Tax Rate model - configurable tax rates per organization
model TaxRate {
  id             String    @id @default(uuid())
  name           String    // e.g., "UK VAT Standard Rate", "US Sales Tax - California"
  taxType        TaxType   @default(VAT)
  rate           Decimal   @db.Decimal(5, 2) // Percentage (e.g., 20.00 for 20%)
  description    String?
  region         String?   // Optional region/state for regional taxes
  isDefault      Boolean   @default(false) // Default tax rate for new POs
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@map("tax_rates")
  @@index([organizationId])
  @@index([organizationId, isDefault])
  @@index([organizationId, isActive])
}

// User Role enum - defines access levels within an organization
enum UserRole {
  ADMIN    // Full access: manage users, settings, all POs
  MANAGER  // Can create, edit, approve, and send POs
  VIEWER   // Read-only access to POs
}

// Purchase Order Status enum
enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  RECEIVED
  CANCELLED
}

// Tax Mode enum - how tax is applied to the purchase order
enum TaxMode {
  INCLUSIVE  // Tax is included in line item prices
  EXCLUSIVE  // Tax is added on top of line item prices
  NONE       // No tax applied
}

// Tax Type enum - different types of taxes
enum TaxType {
  VAT          // Value Added Tax (EU, UK, etc.)
  GST          // Goods and Services Tax (Canada, Australia, India, etc.)
  SALES_TAX    // Sales Tax (US states, etc.)
  CONSUMPTION  // Consumption Tax (Japan, etc.)
  CUSTOM       // Custom/Other tax types
}

// Purchase Order model
model PurchaseOrder {
  id             String    @id @default(uuid())
  poNumber       String    @unique
  title          String
  description    String?
  status         POStatus  @default(DRAFT)

  // Financial fields
  subtotalAmount Decimal   @default(0) @db.Decimal(10, 2) // Amount before tax
  taxMode        TaxMode   @default(EXCLUSIVE) // How tax is calculated
  taxRate        Decimal   @default(0) @db.Decimal(5, 2) // Tax percentage (e.g., 20.00 for 20%) - kept for backward compatibility
  taxAmount      Decimal   @default(0) @db.Decimal(10, 2) // Calculated tax amount
  totalAmount    Decimal   @db.Decimal(10, 2) // Final amount (subtotal + tax for EXCLUSIVE, or subtotal for INCLUSIVE/NONE)
  currency       String    @default("GBP")

  // Tax Rate relation (optional - if null, uses taxRate field above)
  taxRateId      String?
  taxRateConfig  TaxRate?  @relation(fields: [taxRateId], references: [id], onDelete: SetNull)

  orderDate      DateTime  @default(now())
  deliveryDate   DateTime?
  notes          String?

  // Supplier information
  supplierName   String
  supplierEmail  String?
  supplierPhone  String?
  supplierAddress String?

  // FreeAgent integration
  freeAgentId    String?   @unique
  syncedAt       DateTime?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById    String
  createdBy      User      @relation("CreatedPOs", fields: [createdById], references: [id])

  lineItems      POLineItem[]

  @@map("purchase_orders")
  @@unique([organizationId, poNumber]) // Ensure PO numbers are unique per organization
  @@index([organizationId, status]) // Optimize queries filtering by org and status
  @@index([organizationId, orderDate]) // Optimize queries filtering by org and date
  @@index([organizationId]) // Keep for general org queries
}

// Purchase Order Line Item model
model POLineItem {
  id              String   @id @default(uuid())
  description     String
  quantity        Int
  unitPrice       Decimal  @db.Decimal(10, 2)
  totalPrice      Decimal  @db.Decimal(10, 2)
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("po_line_items")
  @@index([purchaseOrderId])
}

// Counter model - for generating sequential numbers (e.g., PO numbers)
// Uses row-level locking to prevent race conditions
model Counter {
  id             String   @id @default(uuid())
  name           String   // e.g., "po_number"
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  value          Int      @default(0)
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, name])
  @@map("counters")
  @@index([organizationId])
}
