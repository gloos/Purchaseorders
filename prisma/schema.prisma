// Prisma schema for PO Tool
// This defines the database models and relationships

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User model - represents authenticated users
// Note: Supabase handles auth in its own schema, this is for app-specific user data
model User {
  id             String        @id @default(uuid()) // Matches Supabase auth.users.id
  email          String        @unique
  name           String?
  avatarUrl      String?
  role           UserRole      @default(VIEWER) // User's role within their organization
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdPurchaseOrders PurchaseOrder[] @relation("CreatedPOs")
  sentInvitations       Invitation[]     @relation("SentInvitations")

  // Approval workflow relations
  approvalRequestsSent     ApprovalRequest[] @relation("Requester")
  approvalRequestsReceived ApprovalRequest[] @relation("Approver")
  approvalActions          ApprovalAction[]

  @@map("users")
}

// Invitation model - tracks pending user invitations
model Invitation {
  id             String        @id @default(uuid())
  email          String
  role           UserRole      @default(VIEWER)
  token          String        @unique @default(uuid())
  expiresAt      DateTime
  status         InvitationStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  acceptedAt     DateTime?

  // Relations
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invitedById    String
  invitedBy      User          @relation("SentInvitations", fields: [invitedById], references: [id])

  @@map("invitations")
  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@unique([email, organizationId])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// Organization model - represents companies/organizations using the tool
model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // FreeAgent OAuth tokens
  freeAgentAccessToken  String?
  freeAgentRefreshToken String?
  freeAgentTokenExpiry  DateTime?

  // Company Profile Information
  companyRegistrationNumber String?
  vatNumber                 String?
  addressLine1              String?
  addressLine2              String?
  city                      String?
  region                    String?
  postcode                  String?
  country                   String?
  phone                     String?
  email                     String?
  website                   String?
  logoUrl                   String?

  // FreeAgent company sync
  freeAgentCompanyUrl       String?
  companySyncedAt           DateTime?

  // FreeAgent Bill Creation Settings
  defaultPaymentTermsDays   Int?      @default(30)
  defaultExpenseCategoryUrl String?

  // Approval workflow settings
  companyName        String?  // Organization name for display in navbar (from signup, not FreeAgent)
  approvalThreshold  Decimal? @default(50) @db.Decimal(10, 2) // POs at or above this subtotal (before tax) need approval
  autoApproveAdmin   Boolean  @default(true) // Admins auto-approve their own POs regardless of amount

  // Relations
  users          User[]
  purchaseOrders PurchaseOrder[]
  contacts       Contact[]
  counters       Counter[]
  taxRates       TaxRate[]
  expenseCategoryMappings ExpenseCategoryMapping[]
  invitations    Invitation[]
  approvalRequests ApprovalRequest[]

  @@map("organizations")
}

// Contact/Supplier model - synced from FreeAgent
model Contact {
  id                String    @id @default(uuid())
  freeAgentId       String    @unique
  name              String
  email             String?
  phone             String?
  address           String?
  isActive          Boolean   @default(true)
  syncedAt          DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("contacts")
  @@index([organizationId])
  @@index([freeAgentId])
}

// Tax Rate model - configurable tax rates per organization
model TaxRate {
  id             String    @id @default(uuid())
  name           String    // e.g., "UK VAT Standard Rate", "US Sales Tax - California"
  taxType        TaxType   @default(VAT)
  rate           Decimal   @db.Decimal(5, 2) // Percentage (e.g., 20.00 for 20%)
  description    String?
  region         String?   // Optional region/state for regional taxes
  isDefault      Boolean   @default(false) // Default tax rate for new POs
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]

  @@map("tax_rates")
  @@index([organizationId])
  @@index([organizationId, isDefault])
  @@index([organizationId, isActive])
}

// User Role enum - defines access levels within an organization
enum UserRole {
  SUPER_ADMIN  // Platform owner with full control (lucegary@gmail.com)
  ADMIN        // Full access: manage users, settings, approve POs, auto-approve own POs
  MANAGER      // Can create and edit POs, needs approval for POs â‰¥ threshold
  VIEWER       // Read-only access to POs, cannot create or edit
}

// Purchase Order Status enum
enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  RECEIVED
  INVOICED
  CANCELLED
}

// Tax Mode enum - how tax is applied to the purchase order
enum TaxMode {
  INCLUSIVE  // Tax is included in line item prices
  EXCLUSIVE  // Tax is added on top of line item prices
  NONE       // No tax applied
}

// Tax Type enum - different types of taxes
enum TaxType {
  VAT          // Value Added Tax (EU, UK, etc.)
  GST          // Goods and Services Tax (Canada, Australia, India, etc.)
  SALES_TAX    // Sales Tax (US states, etc.)
  CONSUMPTION  // Consumption Tax (Japan, etc.)
  CUSTOM       // Custom/Other tax types
}

// Purchase Order model
model PurchaseOrder {
  id             String    @id @default(uuid())
  poNumber       String    @unique
  title          String
  description    String?
  status         POStatus  @default(DRAFT)

  // Financial fields
  subtotalAmount Decimal   @default(0) @db.Decimal(10, 2) // Amount before tax
  taxMode        TaxMode   @default(EXCLUSIVE) // How tax is calculated
  taxRate        Decimal   @default(0) @db.Decimal(5, 2) // Tax percentage (e.g., 20.00 for 20%) - IMMUTABLE snapshot at PO creation time
  taxAmount      Decimal   @default(0) @db.Decimal(10, 2) // Calculated tax amount - IMMUTABLE snapshot for accounting history
  totalAmount    Decimal   @db.Decimal(10, 2) // Final amount (subtotal + tax for EXCLUSIVE, or subtotal for INCLUSIVE/NONE)
  currency       String    @default("GBP")

  // Tax Rate relation (optional reference for auditing - NEVER used for calculations)
  // This preserves a link to the TaxRate that was selected, but taxRate field above holds the actual value
  // If the TaxRate is deleted or modified, this PO's taxRate/taxAmount remain unchanged (accounting integrity)
  taxRateId      String?
  taxRateConfig  TaxRate?  @relation(fields: [taxRateId], references: [id], onDelete: SetNull)

  orderDate      DateTime  @default(now())
  deliveryDate   DateTime?
  notes          String?

  // Supplier information
  supplierName   String
  supplierEmail  String?
  supplierPhone  String?
  supplierAddress String?

  // FreeAgent integration
  freeAgentId    String?   @unique
  syncedAt       DateTime?

  // Invoice upload fields
  invoiceUploadToken          String?   @unique
  invoiceUploadTokenExpiresAt DateTime?
  invoiceUrl                  String?
  invoiceReceivedAt           DateTime?

  // FreeAgent Bill Integration
  freeAgentBillId       String?   @unique
  freeAgentBillUrl      String?
  freeAgentBillCreatedAt DateTime?
  paymentTermsDays      Int?      @default(30)
  freeAgentContactUrl   String?   // Cached matched contact URL

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById    String
  createdBy      User      @relation("CreatedPOs", fields: [createdById], references: [id])

  lineItems      POLineItem[]
  approvalRequest ApprovalRequest?

  @@map("purchase_orders")
  @@unique([organizationId, poNumber]) // Ensure PO numbers are unique per organization
  @@index([organizationId, status]) // Optimize queries filtering by org and status
  @@index([organizationId, orderDate]) // Optimize queries filtering by org and date
  @@index([organizationId]) // Keep for general org queries
}

// Purchase Order Line Item model
model POLineItem {
  id              String   @id @default(uuid())
  description     String
  quantity        Int
  unitPrice       Decimal  @db.Decimal(10, 2)
  totalPrice      Decimal  @db.Decimal(10, 2)
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("po_line_items")
  @@index([purchaseOrderId])
}

// Counter model - for generating sequential numbers (e.g., PO numbers)
// Uses row-level locking to prevent race conditions
model Counter {
  id             String   @id @default(uuid())
  name           String   // e.g., "po_number"
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  value          Int      @default(0)
  updatedAt      DateTime @updatedAt

  @@unique([organizationId, name])
  @@map("counters")
  @@index([organizationId])
}

// Expense Category Mapping model - stores user preferences for mapping line items to FreeAgent categories
model ExpenseCategoryMapping {
  id                    String   @id @default(uuid())
  keyword               String   // e.g., "software", "hardware", "services"
  freeAgentCategoryUrl  String   // FreeAgent category URL
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, keyword])
  @@map("expense_category_mappings")
  @@index([organizationId])
}

// Approval Request model - tracks approval requests for purchase orders
model ApprovalRequest {
  id              String          @id @default(uuid())
  purchaseOrderId String          @unique
  requesterId     String
  approverId      String?         // Null = any admin can approve, set when approved/denied
  status          ApprovalStatus  @default(PENDING)
  amount          Decimal         @db.Decimal(10, 2) // Subtotal amount (before tax) for approval decision
  reason          String?         // Optional reason for request
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  purchaseOrder   PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  requester       User            @relation("Requester", fields: [requesterId], references: [id])
  approver        User?           @relation("Approver", fields: [approverId], references: [id])
  actions         ApprovalAction[]

  organizationId  String
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("approval_requests")
  @@index([status])
  @@index([approverId, status])
  @@index([organizationId])
  @@index([requesterId])
}

// Approval Action model - immutable audit trail of all approval actions
model ApprovalAction {
  id                String             @id @default(uuid())
  approvalRequestId String
  userId            String
  action            ApprovalActionType
  reason            String?            // Denial reason or approval note
  createdAt         DateTime           @default(now())

  // Relations
  approvalRequest   ApprovalRequest    @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)
  user              User               @relation(fields: [userId], references: [id])

  @@map("approval_actions")
  @@index([approvalRequestId])
}

// Approval Status enum
enum ApprovalStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
}

// Approval Action Type enum
enum ApprovalActionType {
  SUBMITTED
  APPROVED
  DENIED
  COMMENTED
  CANCELLED
}
